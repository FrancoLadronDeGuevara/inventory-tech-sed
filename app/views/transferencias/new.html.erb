<div class="border-b bg-white border-gray-300 pl-6 py-2 shadow-sm text-xl font-bold">
  Nueva Transferencia
</div>

<div class="p-6">
  <%= form_with(model: @transferencia, local: true, class: "space-y-4") do |form| %>
    <% if @transferencia&.errors&.any? %>
      <div class="mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded">
        <h2 class="font-bold">Se encontraron <%= @transferencia.errors.count %> errores:</h2>
        <ul class="list-disc pl-6">
          <% @transferencia.errors.full_messages.each do |msg| %>
            <li><%= msg %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div>
      <%= form.label :articulo_id, "Artículo", class: "block font-medium text-gray-700 mb-1" %>
      <%= form.collection_select :articulo_id,
            Articulo.includes(:portador_actual).order(:marca, :modelo),
            :id,
            ->(a){ "#{a.marca} #{a.modelo}" },
            { include_blank: "Seleccione un artículo" },
            class: "block w-full rounded-lg border border-gray-300 bg-white py-2 px-3 text-sm text-gray-900" %>
    </div>

    <div>
      <label class="block font-medium text-gray-700 mb-1">Portador actual</label>
      <input type="text" id="portador_actual" readonly
       value="<%= j(@transferencia.articulo&.portador_actual&.nombre_completo || '-') %>"
       class="block w-full rounded-lg border border-gray-300 bg-gray-100 py-2 px-3 text-sm text-gray-900">

    </div>

    <div>
      <%= form.label :portador_nuevo_id, "Nuevo portador", class: "block font-medium text-gray-700 mb-1" %>
      <%= form.collection_select :portador_nuevo_id, Persona.order(:apellido, :nombre), :id, :nombre_completo,
            { include_blank: "Seleccione una persona" },
            class: "block w-full rounded-lg border border-gray-300 bg-white py-2 px-3 text-sm text-gray-900" %>
    </div>

    <div>
      <%= form.label :fecha_transferencia, "Fecha de transferencia", class: "block font-medium text-gray-700 mb-1" %>
      <%= form.date_field :fecha_transferencia,
            class: "block w-full rounded-lg border border-gray-300 bg-white py-2 px-3 text-sm text-gray-900" %>
    </div>

    <div>
      <%= form.submit "Guardar", class: "bg-gray-800 text-white px-4 py-2 rounded-lg hover:bg-gray-700 cursor-pointer" %>
    </div>
  <% end %>
</div>

<script>
  function initializeTransferForm() {
    const articuloSelect = document.getElementById("transferencia_articulo_id");
    const portadorInput = document.getElementById("portador_actual");

    if (!articuloSelect || !portadorInput) return;

    const portadoresActuales = <%= raw(
      Articulo.includes(:portador_actual).map { |a|
        [a.id.to_s, (a.portador_actual&.nombre_completo || 'Sin portador')]
      }.to_h.to_json
    ) %>;

    const actualizarPortador = () => {
      const selected = articuloSelect.value;
      portadorInput.value = selected ? (portadoresActuales[selected] || "Sin portador") : "-";
    };

    articuloSelect.removeEventListener("change", actualizarPortador);
    
    actualizarPortador();

    articuloSelect.addEventListener("change", actualizarPortador);
  }

  document.addEventListener("turbo:load", initializeTransferForm);

  document.addEventListener("DOMContentLoaded", initializeTransferForm);
  
  if (document.readyState === "loading") {
  } else {
    initializeTransferForm();
  }
</script>
